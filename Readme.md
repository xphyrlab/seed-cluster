# Installing Seed Cluster in OpenShift
## This guide outlines the steps for installing a Seed Cluster in OpenShift.


### Directory Structure:
 1. Create a directory named openshift under your desired installation directory. This will hold your machine configuration file.
 2. Inside the openshift directory, create a machine configuration file (e.g., machine-config.yaml).
    Ensure the file specifies a partition named varlibcontainers with at least 522,240 MiB size and starting after 133,120 MiB (accounting for a 120 GB pre-allocated space).

        apiVersion: machineconfiguration.openshift.io/v1
        kind: MachineConfig
        metadata:
          labels:
            machineconfiguration.openshift.io/role: master
          name: 98-var-lib-containers-partitioned
        spec:
          config:
            ignition:
              version: 3.2.0
            storage:
              disks:
                - device: /dev/sda 
                  partitions:
                    - label: varlibcontainers
                      startMiB: 133120
                      sizeMiB: 522240
              filesystems:
                - device: /dev/disk/by-partlabel/varlibcontainers
                  format: xfs
                  mountOptions:
                    - defaults
                    - prjquota
                  path: /var/lib/containers
                  wipeFilesystem: true
            systemd:
              units:
                - contents: |-
                    # Generated by Butane
                    [Unit]
                    Before=local-fs.target
                    Requires=systemd-fsck@dev-disk-by\x2dpartlabel-varlibcontainers.service
                    After=systemd-fsck@dev-disk-by\x2dpartlabel-varlibcontainers.service
        
            [Mount]
            Where=/var/lib/containers
            What=/dev/disk/by-partlabel/varlibcontainers
            Type=xfs
            Options=defaults,prjquota

            [Install]
            RequiredBy=local-fs.target
          enabled: true
          name: var-lib-containers.mount
    
    Note: On the virtual machine (VM) where you plan to install the Seed Cluster, set the disk.enableUUID parameter to TRUE.

### Image Creation:
   Open a terminal and use the cd command to navigate to the directory where the installation directory is present. The installation directory must contain the following files
   
   1. agent-config.yaml
   2. install-config.yaml
   3. openshift/machine-config.yaml
   
   Run the following command to create the installation:
     
     $ openshift-install --dir install agent create image


### Generating a seed image with the Lifecycle Agent
   1. Install Lifecycle Operator for the Operator Hub.

   2. Generate Seed Auth
    Set the AUTHFILE environment variable to point to the location of your container authentication file:
    
     $ export AUTHFILE=${XDG_RUNTIME_DIR}/containers/auth.json
     $ base64 -w 0 ${AUTHFILE} ; echo

   3. Copy the output into the seedAuth field in a Secret CR named seedgen in the openshift-lifecycle-agent namespace.

          apiVersion: v1
          kind: Secret
          metadata:
            name: seedgen 
            namespace: openshift-lifecycle-agent
          type: Opaque
          data:
            seedAuth: <encoded_AUTHFILE>

   4. Apply the Secret.
      
          $ oc apply -f secretseedgenerator.yaml

   5. Create the SeedGenerator CR:

           apiVersion: lca.openshift.io/v1
           kind: SeedGenerator
           metadata:
             name: seedimage 
           spec:
             seedImage: quay.io/rh-ee-saahmed/seedsno2:4.16

      Note: Specify the container image URL, for example, quay.io/example/seed-container-image:<tag>. It is recommended to use the <seed_cluster_name>:<ocp_version> format.
      
   6. Generate the seed image by running the following command:

          $ oc apply -f seedgenerator.yaml

      ### Important:
      During the seed generation process, the cluster temporarily loses API capabilities because Lifecycle Agent stops OpenShift Container Platform and shuts down all  running Operators and pods. When the process completes, Lifecycle Agent restarts OpenShift Container Platform, which triggers the recovery of the Operators.
    
### Create Live Installation ISO
1. Extract the ib-cli CLI tool from the Lifecycle Agent:
   a) Create a temporary container for the Lifecycle Agent image by running the following command:

       $ podman create --name temp_container quay.io/openshift-kni/lifecycle-agent-operator:4.16

   b) Copy the ib-cli CLI tool from the container to the local host by running the following command:

       $ podman cp temp_container:/usr/local/bin/ib-cli .


 2. Create a working directory by running the following:

         mkdir ibi-iso-workdir

 3.  Create a YAML file called image-based-install-iso.yaml in your working directory to define the installation artifacts:

          seedImage: quay.io/repo-id/seed:latest
          seedVersion: 4.16.0
          pullSecret: |
            {"auths": ...}
          installationDisk: /dev/disk/by-id/wwn-0x62c...
          sshKey: 'ssh-ed25519 AAAA...'
          rhcosLiveIso="https://mirror.openshift.com/pub/openshift-v4/amd64/dependencies/rhcos/latest/rhcos-live.x86_64.iso"

          
### Note: Remeber to include rhcosLiveIso in image-based-iso.yaml
### Refer https://github.com/openshift-kni/lifecycle-agent/tree/main/ib-cli for customizing the image-based-install-iso.yaml file.
 
